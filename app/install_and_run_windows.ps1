# =============================
# üöÄ INSTALLATEUR AUTOMATIQUE GUI
# Gestion Financi√®re Little
# =============================

Add-Type -AssemblyName PresentationFramework

function Show-Message {
    param ($title, $message, $type = "Info")
    [System.Windows.MessageBox]::Show($message, $title, [System.Windows.MessageBoxButton]::OK, [System.Windows.MessageBoxImage]::$type)
}

function Show-Progress {
    param($message)
    Write-Host ""
    Write-Host "üïê $message..."
}

function Download-File {
    param ($url, $destination)
    $client = New-Object System.Net.WebClient
    $client.DownloadFile($url, $destination)
}

# 1Ô∏è‚É£ V√©rification des droits administrateur
if (-not ([Security.Principal.WindowsPrincipal] [Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltinRole]::Administrator)) {
    Show-Message "Droits administrateur requis" "‚ùå Ce script doit √™tre lanc√© en tant qu'administrateur.`nClique droit ‚Üí Ex√©cuter avec PowerShell (Administrateur)" "Error"
    exit
}

# 2Ô∏è‚É£ V√©rifier Python
Show-Progress "V√©rification de Python"
$pythonInstalled = Get-Command python -ErrorAction SilentlyContinue

if (-not $pythonInstalled) {
    $answer = [System.Windows.MessageBox]::Show("Python n'est pas install√©.`nVoulez-vous l'installer automatiquement ?", "Installation de Python", [System.Windows.MessageBoxButton]::YesNo, [System.Windows.MessageBoxImage]::Question)
    if ($answer -eq "No") { exit }

    $url = "https://www.python.org/ftp/python/3.13.0/python-3.13.0-amd64.exe"
    $installer = "$env:TEMP\python_installer.exe"
    Show-Progress "T√©l√©chargement de Python 3.13..."
    Download-File $url $installer

    Show-Progress "Installation silencieuse de Python"
    Start-Process -FilePath $installer -ArgumentList "/quiet InstallAllUsers=1 PrependPath=1 Include_test=0" -Wait
    Remove-Item $installer -ErrorAction SilentlyContinue
    Show-Message "Installation termin√©e" "‚úÖ Python 3.13 a √©t√© install√© avec succ√®s !" "Information"
}

# 3Ô∏è‚É£ V√©rifier pip
Show-Progress "V√©rification de pip"
try {
    python -m ensurepip --upgrade | Out-Null
    python -m pip install --upgrade pip setuptools wheel | Out-Null
} catch {
    Show-Message "Erreur pip" "‚ùå Impossible d'installer pip automatiquement.`nVeuillez r√©essayer apr√®s red√©marrage du PC." "Error"
    exit
}

# 4Ô∏è‚É£ Installer les d√©pendances
Show-Progress "Installation des d√©pendances (cela peut prendre quelques minutes)"
try {
    python -m pip install --upgrade streamlit pandas pytesseract Pillow python-dateutil opencv-python-headless numpy matplotlib pdfminer.six requests | Out-Null
} catch {
    Show-Message "Erreur" "‚ùå L'installation des d√©pendances a √©chou√©.`nV√©rifiez votre connexion internet." "Error"
    exit
}
Show-Message "D√©pendances install√©es" "‚úÖ Toutes les d√©pendances ont √©t√© install√©es avec succ√®s !" "Information"

# 5Ô∏è‚É£ Lancer l‚Äôapplication
Show-Progress "Lancement de Gestion Financi√®re Little"
try {
    Start-Process "python" "-m streamlit run gestiolittle.py --server.headless true"
    Show-Message "Application lanc√©e" "üöÄ Gestion Financi√®re Little a √©t√© d√©marr√©e avec succ√®s !" "Information"
} catch {
    Show-Message "Erreur" "‚ùå Impossible de d√©marrer l'application." "Error"
}
