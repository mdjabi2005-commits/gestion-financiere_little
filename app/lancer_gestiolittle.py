import os
import sys
import subprocess
import webbrowser
import time
import socket
import shutil
import json
from pathlib import Path

# ====================================================
# üîß V√©rification de Python et Streamlit
# ====================================================

def have_python():
    """V√©rifie si 'python' est disponible dans le PATH."""
    return shutil.which("python") is not None

def have_streamlit():
    """V√©rifie si Streamlit est install√© pour le Python courant."""
    try:
        import streamlit
        return True
    except ImportError:
        return False

def lancer_launcher():
    """Lance le fichier d‚Äôinstallation ou de lancement selon la plateforme."""
    base_dir = os.path.dirname(os.path.abspath(sys.executable if getattr(sys, 'frozen', False) else __file__))
    bat_path = os.path.join(base_dir, "Lancer_GFL.bat")
    ps1_path = os.path.join(base_dir, "install_and_run_windows.ps1")

    print("‚û°Ô∏è Python ou Streamlit manquant ‚Äî lancement du programme d‚Äôinstallation...")
    if os.path.exists(bat_path):
        try:
            os.startfile(bat_path)
            print("‚úÖ Lancement du fichier batch r√©ussi.")
        except Exception as e:
            print(f"‚ùå Erreur lors du lancement du .bat : {e}")
    elif os.path.exists(ps1_path):
        try:
            subprocess.run(["powershell", "-ExecutionPolicy", "Bypass", "-File", ps1_path])
            print("‚úÖ Script PowerShell ex√©cut√©.")
        except Exception as e:
            print(f"‚ùå Erreur lors de l'ex√©cution du PowerShell : {e}")
    else:
        print("‚ùå Aucun fichier d‚Äôinstallation trouv√© dans le dossier.")
        input("\nAppuie sur Entr√©e pour fermer‚Ä¶")
        sys.exit(1)

# ====================================================
# üìò Ouverture automatique du guide d‚Äôinstallation
# ====================================================

def ouvrir_guide_installation():
    """Ouvre le guide d'installation si c'est le premier lancement"""
    config_dir = Path.home() / ".gestiolittle"
    config_file = config_dir / "config.json"
    config_dir.mkdir(exist_ok=True)

    if config_file.exists():
        with open(config_file, 'r', encoding='utf-8') as f:
            config = json.load(f)
    else:
        config = {"premier_lancement": True, "lancements": 0}

    config["lancements"] = config.get("lancements", 0) + 1
    premier_lancement = config.get("premier_lancement", True)
    lancements = config.get("lancements", 0)

    guide_path = Path(__file__).parent / "GUIDE_INSTALLATION.md"
    ouvrir_guide = False

    if premier_lancement:
        print("üéâ Premier lancement - Ouverture du guide d'installation...")
        ouvrir_guide = True
        config["premier_lancement"] = False
    elif lancements % 10 == 0:
        print("üìñ Rappel - Ouverture du guide d'installation...")
        ouvrir_guide = True

    with open(config_file, 'w', encoding='utf-8') as f:
        json.dump(config, f, indent=2)

    if ouvrir_guide and guide_path.exists():
        try:
            if sys.platform == "win32":
                os.startfile(str(guide_path))
            elif sys.platform == "darwin":
                subprocess.run(["open", str(guide_path)])
            else:
                subprocess.run(["xdg-open", str(guide_path)])
            print("üìö Guide d'installation ouvert !")
            time.sleep(2)
        except Exception as e:
            print(f"‚ùå Impossible d'ouvrir le guide: {e}")

# ====================================================
# üåê Gestion du lancement Streamlit
# ====================================================

def wait_for_port(port, timeout=20):
    """Attend que le port Streamlit soit ouvert (jusqu'√† timeout secondes)."""
    start = time.time()
    while time.time() - start < timeout:
        try:
            with socket.create_connection(("localhost", port), timeout=1):
                return True
        except OSError:
            time.sleep(0.5)
    return False

def get_base_path():
    """Retourne le chemin de base, m√™me si le programme est compil√© avec PyInstaller."""
    if getattr(sys, 'frozen', False):
        return sys._MEIPASS
    return os.path.dirname(os.path.abspath(__file__))

def find_app_path(base_path):
    """Cherche le fichier gestiolittle.py √† partir de l'emplacement courant."""
    candidates = [
        os.path.join(base_path, "gestiolittle.py"),
        os.path.join(os.path.dirname(base_path), "gestiolittle.py"),
        os.path.join(os.getcwd(), "gestiolittle.py")
    ]
    for path in candidates:
        if os.path.exists(path):
            return path

    print("‚ùå Impossible de trouver gestiolittle.py")
    print("Chemins test√©s :")
    for p in candidates:
        print(f"   - {p}")
    input("\nAppuie sur Entr√©e pour fermer‚Ä¶")
    sys.exit(1)

def launch_streamlit(app_path, port=8501):
    """Lance Streamlit proprement et ouvre le navigateur quand le serveur est pr√™t."""
    streamlit_exe = shutil.which("streamlit")
    if not streamlit_exe:
        print("‚ùå Streamlit introuvable !")
        input("Appuie sur Entr√©e pour fermer‚Ä¶")
        sys.exit(1)

    if sys.platform == "win32":
        cmd = ["powershell", "-Command", f'& "{streamlit_exe}" run "{app_path}" --server.port {port}']
    else:
        cmd = [streamlit_exe, "run", app_path, "--server.port", str(port)]

    print(f"Lancement de Streamlit √† partir de : {streamlit_exe}")
    print(f"Application : {app_path}")

    process = subprocess.Popen(cmd, stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)

    if wait_for_port(port, timeout=30):
        print("‚úÖ Serveur pr√™t ! Ouverture du navigateur‚Ä¶")
        webbrowser.open(f"http://localhost:{port}")
    else:
        print("‚ö†Ô∏è Le serveur Streamlit ne s'est pas lanc√© correctement.")
        input("\nAppuie sur Entr√©e pour fermer‚Ä¶")
        sys.exit(1)

    return process

# ====================================================
# üöÄ Point d‚Äôentr√©e principal unifi√©
# ====================================================

def main():
    print("üöÄ D√©marrage de Gestion Financi√®re Little‚Ä¶")
    print("‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ")

    # 1Ô∏è‚É£ V√©rifier Python et Streamlit
    if not have_python() or not have_streamlit():
        print("‚ö†Ô∏è Python ou Streamlit non d√©tect√©.")
        lancer_launcher()
        sys.exit(0)

    # 2Ô∏è‚É£ Ouvrir le guide d'installation si n√©cessaire
    ouvrir_guide_installation()

    # 3Ô∏è‚É£ Lancer l'application Streamlit
    base_path = get_base_path()
    app_path = find_app_path(base_path)
    launch_streamlit(app_path)

    print("‚úÖ Application lanc√©e avec succ√®s.")
    print("üí° Ferme cette fen√™tre pour arr√™ter l'application.")
    try:
        while True:
            time.sleep(1)
    except KeyboardInterrupt:
        print("\nüõë Arr√™t de l'application...")
        sys.exit(0)

if __name__ == "__main__":
    main()
