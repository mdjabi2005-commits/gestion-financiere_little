name: 🚀 Build & Release Gestion Financière Little

permissions:
  contents: write  # nécessaire pour créer les releases
  actions: read

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    name: Build et Release multi-plateforme
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-latest, ubuntu-latest, macos-latest]

    steps:
      - name: 🧰 Checkout du code
        uses: actions/checkout@v4

      - name: 🐍 Installer Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: 📦 Installer les dépendances
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: 🏗️ Compiler l’application
        run: |
          if [[ "$RUNNER_OS" == "Windows" ]]; then
            pyinstaller --onefile lancer_gestiolittle.py
          elif [[ "$RUNNER_OS" == "Linux" ]]; then
            pyinstaller --onefile lancer_gestiolittle.py
          else
            pyinstaller --onefile lancer_gestiolittle.py
          fi
        shell: bash

      # 🧩 Installation du SDK Windows pour avoir signtool
      - name: 🧩 Installer Windows SDK pour obtenir signtool
        if: runner.os == 'Windows'
        run: choco install windows-sdk-10-version-2004-all -y

      # 🪪 Import du certificat de signature
      - name: 🪪 Importer le certificat PFX
        if: runner.os == 'Windows'
        shell: powershell
        run: |
          $bytes = [System.Convert]::FromBase64String("${{ secrets.CODESIGN_PFX_BASE64 }}")
          [IO.File]::WriteAllBytes("codesign.pfx", $bytes)

      # 🔏 Signature de l’exécutable Windows
      - name: 🔏 Signer l'exécutable Windows
        if: runner.os == 'Windows'
        shell: powershell
        run: |
          # 🔍 Cherche signtool.exe dans la version x64 en priorité
          $signtool = Get-ChildItem "C:\Program Files (x86)\Windows Kits\10\bin\" -Recurse -Filter signtool.exe |
            Where-Object { $_.FullName -match "\\x64\\" } |
            Select-Object -First 1 -ExpandProperty FullName

          if (-not $signtool) {
            Write-Host "⚠️ signtool.exe (x64) non trouvé, tentative de fallback général..."
            $signtool = Get-ChildItem "C:\Program Files (x86)\Windows Kits\10\bin\" -Recurse -Filter signtool.exe |
              Select-Object -First 1 -ExpandProperty FullName
          }

          if (-not $signtool) {
            Write-Error "❌ Aucun signtool valide trouvé sur le système."
            exit 1
          }

          Write-Host "✅ signtool utilisé : $signtool"

          # 🪪 Signature du fichier (exécution directe)
          & "$signtool" sign /f "codesign.pfx" /p "${{ secrets.CODESIGN_PFX_PASSWORD }}" `
            /tr http://timestamp.digicert.com /td sha256 /fd sha256 `
            "dist\lancer_gestiolittle.exe"

          if ($LASTEXITCODE -ne 0) {
            Write-Error "❌ Erreur lors de la signature du fichier."
            exit $LASTEXITCODE
          }

          Write-Host "✅ Signature terminée avec succès."

      # 📤 Création de la release GitHub
      - name: 📤 Upload de l’exécutable pour la Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ github.run_number }}
          name: "Gestion Financière Little v${{ github.run_number }}"
          body: |
            🚀 Nouvelle version générée automatiquement.

            ✅ Compatible Windows, Linux et macOS.
            🔏 L’exécutable Windows est signé numériquement.
          files: |
            dist/lancer_gestiolittle*
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

