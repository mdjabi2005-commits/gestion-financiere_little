name: üöÄ Build & Release Gestion Financi√®re Little

permissions:
  contents: write
  actions: read

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    name: Build et Release multi-plateforme
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-latest, ubuntu-latest, macos-latest]

    steps:
      - name: üß∞ Checkout du code
        uses: actions/checkout@v4

      - name: üêç Installer Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
      
      - name: üì¶ Cache Python dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            ~/AppData/Local/pip/Cache
          key: ${{ runner.os }}-pip-${{ hashFiles('app/requirements.txt', 'requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: üì¶ Copier le dossier Tesseract depuis le d√©p√¥t
        if: runner.os == 'Windows'
        run: |
          if [ -d "tesseract" ]; then
            echo "üìÇ Dossier tesseract trouv√© dans le d√©p√¥t"
            mkdir -p dist/tesseract
            cp -r tesseract/* dist/tesseract/
            echo "‚úÖ Tesseract local copi√© dans dist/"
          else
            echo "‚ö†Ô∏è Aucun dossier tesseract trouv√© dans le d√©p√¥t"
          fi
        shell: bash

      
      - name: üìù Cr√©er le dossier dist
        run: |
          mkdir -p dist
          echo "‚úÖ Dossier dist cr√©√©"
        shell: bash

      - name: üìù Cr√©er script de lancement pour Linux/macOS
        if: runner.os != 'Windows'
        run: |
          cat > dist/run.sh << 'RUNSCRIPT'
          #!/bin/bash
          # Script de lancement Gestion Financi√®re Little
          
          # Obtenir le r√©pertoire du script
          SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
          cd "$SCRIPT_DIR"
          
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "  üöÄ Gestion Financi√®re Little"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo ""
          echo "üìÇ R√©pertoire de travail: $SCRIPT_DIR"
          echo ""
          
          # D√©tection sp√©cifique de MX Linux et d√©riv√©s Debian
          detect_linux_distro() {
              if [ -f /etc/os-release ]; then
                  . /etc/os-release
                  # D√©tection sp√©cifique pour MX Linux
                  if [ -f /etc/mx-version ]; then
                      echo "MX Linux"
                  else
                      echo "$NAME"
                  fi
              elif command -v lsb_release &> /dev/null; then
                  lsb_release -d | cut -f2
              else
                  echo "Unknown"
              fi
          }
          
          DISTRO=$(detect_linux_distro)
          echo "üêß Distribution d√©tect√©e: $DISTRO"
          echo ""
          
          # Fonction pour installer Tesseract OCR
          install_tesseract() {
              echo "üì¶ Installation de Tesseract OCR..."
              case "$DISTRO" in
                  *"Debian"*|*"Ubuntu"*|*"MX"*|*"Linux Mint"*)
                      sudo apt-get update
                      sudo apt-get install -y tesseract-ocr tesseract-ocr-fra || {
                          echo "‚ùå Impossible d'installer Tesseract OCR"
                          return 1
                      }
                      ;;
                  *"Fedora"*|*"Red Hat"*|*"CentOS"*)
                      sudo dnf install -y tesseract tesseract-langpack-fra || {
                          echo "‚ùå Impossible d'installer Tesseract OCR"
                          return 1
                      }
                      ;;
                  *"Arch"*|*"Manjaro"*)
                      sudo pacman -S --noconfirm tesseract tesseract-data-fra || {
                          echo "‚ùå Impossible d'installer Tesseract OCR"
                          return 1
                      }
                      ;;
                  *"macOS"*|*"Darwin"*)
                      if ! command -v brew &> /dev/null; then
                          echo "üì¶ Installation de Homebrew..."
                          /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
                      fi
                      brew install tesseract tesseract-lang || {
                          echo "‚ùå Impossible d'installer Tesseract OCR"
                          return 1
                      }
                      ;;
              esac
              echo "‚úÖ Tesseract OCR install√© avec succ√®s !"
              return 0
          }
          # Fonction pour installer les d√©pendances OpenCV
          install_opencv_deps() {
              echo "üì¶ Installation des d√©pendances OpenCV..."
              case "$DISTRO" in
                  *"Debian"*|*"Ubuntu"*|*"MX"*|*"Linux Mint"*)
                      sudo apt-get install -y libglib2.0-0 libsm6 libxrender1 libxext6 libgl1 || {
                          echo "‚ùå Impossible d'installer les d√©pendances OpenCV"
                          return 1
                      }
                      ;;
                  *"Fedora"*|*"Red Hat"*|*"CentOS"*)
                      sudo dnf install -y glib2 libSM libXrender libXext mesa-libGL || {
                          echo "‚ùå Impossible d'installer les d√©pendances OpenCV"
                          return 1
                      }
                      ;;
                  *"Arch"*|*"Manjaro"*)
                      sudo pacman -S --noconfirm glib2 libsm libxrender libxext mesa || {
                          echo "‚ùå Impossible d'installer les d√©pendances OpenCV"
                          return 1
                      }
                      ;;
              esac
              echo "‚úÖ D√©pendances OpenCV install√©es avec succ√®s !"
              return 0
          }
          
          # V√©rifier la version de Python
          check_python_version() {
              python3 -c "import sys; exit(0) if sys.version_info >= (3, 8) else exit(1)" || {
                  echo "‚ùå Python 3.8+ requis. Version actuelle: $(python3 --version)"
                  return 1
              }
              return 0
          }
          
          # V√©rifier Python
          if ! command -v python3 &> /dev/null; then
              echo "‚ö†Ô∏è  Python 3 n'est pas install√© sur votre syst√®me."
              echo ""
              read -p "‚ùì Voulez-vous que je l'installe automatiquement ? (o/N) " response
              
              if [[ "$response" =~ ^[OoYy]$ ]]; then
                  case "$DISTRO" in
                      *"Debian"*|*"Ubuntu"*|*"MX"*|*"Linux Mint"*)
                          sudo apt-get update || {
                              echo "‚ùå √âchec de la mise √† jour des paquets"
                              exit 1
                          }
                          sudo apt-get install -y python3 python3-pip python3-venv python3-full || {
                              echo "‚ùå √âchec de l'installation automatique."
                              echo "üìã Essayez manuellement : sudo apt install python3 python3-pip python3-venv"
                              exit 1
                          }
                          ;;
                      *"Fedora"*|*"Red Hat"*|*"CentOS"*)
                          sudo dnf install -y python3 python3-pip python3-virtualenv || {
                              echo "‚ùå √âchec de l'installation automatique."
                              echo "üìã Essayez manuellement : sudo dnf install python3 python3-pip"
                              exit 1
                          }
                          ;;
                      *"Arch"*|*"Manjaro"*)
                          sudo pacman -S --noconfirm python python-pip python-virtualenv || {
                              echo "‚ùå √âchec de l'installation automatique."
                              echo "üìã Essayez manuellement : sudo pacman -S python python-pip"
                              exit 1
                          }
                          ;;
                      *"macOS"*|*"Darwin"*)
                          if ! command -v brew &> /dev/null; then
                              echo "üì¶ Installation de Homebrew..."
                              /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
                          fi
                          brew install python@3.11 || {
                              echo "‚ùå √âchec de l'installation automatique."
                              echo "üìã Essayez manuellement : brew install python@3.11"
                              exit 1
                          }
                          ;;
                      *)
                          echo "‚ùå Distribution non support√©e pour l'installation automatique."
                          echo "üìã Installez Python manuellement pour votre distribution."
                          exit 1
                          ;;
                  esac
                  echo "‚úÖ Python install√© avec succ√®s !"
              else
                  echo ""
                  echo "üìã Installez Python manuellement, puis relancez ce script."
                  exit 1
              fi
          fi
          
          # V√©rifier la version de Python
          check_python_version || exit 1
          echo "‚úÖ Python d√©tect√©: $(python3 --version)"
          echo ""
          
          # V√©rifier et installer Tesseract OCR
          if ! command -v tesseract &> /dev/null; then
              echo "üîç Tesseract OCR non d√©tect√©."
              echo ""
              read -p "‚ùì Voulez-vous installer Tesseract OCR (n√©cessaire pour l'OCR) ? (O/n) " tesseract_response
              
              if [[ "$tesseract_response" =~ ^[OoYy]*$ ]] || [ -z "$tesseract_response" ]; then
                  install_tesseract || {
                      echo "‚ö†Ô∏è  Tesseract OCR n'est pas install√©. L'OCR ne fonctionnera pas."
                  }
              else
                  echo "‚ö†Ô∏è  Tesseract OCR non install√©. L'OCR ne fonctionnera pas."
              fi
          else
              echo "‚úÖ Tesseract OCR d√©tect√©: $(tesseract --version | head -n1)"
          fi
          # Installer les d√©pendances OpenCV
          echo ""
          echo "üîç Installation des d√©pendances OpenCV..."
          install_opencv_deps || {
              echo "‚ö†Ô∏è  Les d√©pendances OpenCV ne sont pas install√©es. Certaines fonctionnalit√©s peuvent ne pas fonctionner."
          }
          echo ""
          
          # Utilisation d'un environnement virtuel
          VENV_DIR="$SCRIPT_DIR/.little_finance_env"
          echo "üîß Configuration de l'environnement Python..."
          
          # Sur Debian/Ubuntu, installer python3-venv de mani√®re pr√©ventive
          # (le test 'import venv' peut r√©ussir m√™me si ensurepip manque sur Ubuntu 24.04)
          case "$DISTRO" in
              *"Debian"*|*"Ubuntu"*|*"MX"*|*"Linux Mint"*)
                  echo "üì¶ Installation de python3-venv (requis sur Debian/Ubuntu)..."
                  PYTHON_VERSION=$(python3 --version 2>&1 | grep -oP '\d+\.\d+')
                  sudo apt-get install -y python${PYTHON_VERSION}-venv python3-venv python3-full 2>/dev/null || {
                      sudo apt-get install -y python3-venv python3-full 2>/dev/null || true
                  }
                  ;;
          esac
          
          # V√©rifier si l'environnement existe d√©j√†
          if [ ! -d "$VENV_DIR" ]; then
              echo "üì¶ Cr√©ation de l'environnement virtuel Python..."
              
              # V√©rifier si python3-venv est install√©
              if ! python3 -c "import venv" 2>/dev/null; then
                  echo "‚ö†Ô∏è  Le module venv n'est pas disponible."
                  echo "üì¶ Installation de python3-venv..."
                  
                  case "$DISTRO" in
                      *"Debian"*|*"Ubuntu"*|*"MX"*|*"Linux Mint"*)
                          # Installer python3-venv pour la version Python d√©tect√©e
                          PYTHON_VERSION=$(python3 --version 2>&1 | grep -oP '\d+\.\d+')
                          sudo apt-get install -y python${PYTHON_VERSION}-venv python3-venv python3-full || {
                              echo "‚ùå Impossible d'installer python${PYTHON_VERSION}-venv"
                              # Fallback: essayer juste python3-venv
                              sudo apt-get install -y python3-venv python3-full || {
                                  echo "‚ùå Impossible d'installer python3-venv"
                                  echo "üí° Essayez: sudo apt install python${PYTHON_VERSION}-venv python3-full"
                                  exit 1
                              }
                          }
                          ;;
                      *"Fedora"*|*"Red Hat"*|*"CentOS"*)
                          sudo dnf install -y python3-virtualenv || {
                              echo "‚ùå Impossible d'installer python3-virtualenv"
                              exit 1
                          }
                          ;;
                      *"Arch"*|*"Manjaro"*)
                          sudo pacman -S --noconfirm python-virtualenv || {
                              echo "‚ùå Impossible d'installer python-virtualenv"
                              exit 1
                          }
                          ;;
                      *"macOS"*|*"Darwin"*)
                          echo "‚úÖ venv devrait √™tre disponible avec Python"
                          ;;
                  esac
              fi
              
              echo "‚è≥ Cr√©ation en cours (cela peut prendre 30-60 secondes)..."
              python3 -m venv "$VENV_DIR" --upgrade-deps 2>&1 | while IFS= read -r line; do
                  echo "   $line"
              done || {
                  echo "‚ùå Impossible de cr√©er l'environnement virtuel"
                  exit 1
              }
              echo "‚úÖ Environnement virtuel cr√©√© !"
          else
              echo "‚úÖ Environnement virtuel existant d√©tect√©"
          fi
          
          # Activer l'environnement virtuel
          source "$VENV_DIR/bin/activate"
          echo "‚úÖ Environnement virtuel activ√©"
          
          # V√©rifier si l'installation initiale est compl√®te
          SETUP_FLAG="$VENV_DIR/.setup_complete"
          if [ -f "$SETUP_FLAG" ]; then
              echo "‚úÖ D√©pendances d√©j√† install√©es (installation ignor√©e)"
              echo "üí° Pour r√©installer, supprimez: $SETUP_FLAG"
          else
              # Installation de TOUTES les d√©pendances Python
              echo "üì¶ Installation des d√©pendances Python..."
          echo "‚è≥ Cela peut prendre plusieurs minutes (surtout sur WSL)..."
          python -m pip install --upgrade pip --verbose 2>&1 | grep -E "(Successfully|Collecting|Downloading|Installing|ERROR)" || true
          python -m pip install streamlit pandas pytesseract Pillow python-dateutil opencv-python-headless numpy plotly regex pdfminer.six PyYAML requests --verbose 2>&1 | grep -E "(Successfully|Collecting|Downloading|Installing|Building|ERROR)" || {
              echo "‚ùå Erreur lors de l'installation des d√©pendances"
              echo "üîÅ Nouvelle tentative avec des options √©tendues..."
              python -m pip install streamlit pandas pytesseract Pillow python-dateutil opencv-python-headless numpy plotly regex pdfminer.six PyYAML requests --no-cache-dir --verbose 2>&1 | grep -E "(Successfully|Collecting|Downloading|Installing|Building|ERROR)" || {
                  echo "‚ùå √âchec critique de l'installation des d√©pendances"
                  exit 1
              }
          }
          echo "‚úÖ D√©pendances install√©es dans l'environnement virtuel !"
          
          # V√©rification CRITIQUE que pytesseract est bien install√©
          echo "üîç V√©rification de l'installation de pytesseract..."
          python -c "import pytesseract; print('‚úÖ pytesseract import√© avec succ√®s')" || {
              echo "‚ùå pytesseract non install√©, tentative de r√©installation..."
              python -m pip install pytesseract --force-reinstall --no-cache-dir || {
                  echo "‚ùå √âchec critique de l'installation de pytesseract"
                  echo "üí° Le module OCR ne fonctionnera pas"
              }
          }
          # V√©rification de OpenCV
          echo "üîç V√©rification de l'installation de OpenCV..."
          python -c "import cv2; print('‚úÖ OpenCV import√© avec succ√®s')" || {
              echo "‚ùå OpenCV non install√©, tentative de r√©installation..."
              python -m pip install opencv-python-headless --force-reinstall --no-cache-dir || {
                  echo "‚ùå √âchec critique de l'installation de OpenCV"
                  echo "üí° Le traitement d'image ne fonctionnera pas"
              }
          }
          
          # V√©rification finale de toutes les d√©pendances
          echo "üîç V√©rification finale des d√©pendances..."
          python -c "
          try:
              import streamlit
              import pandas
              import pytesseract
              import PIL
              import dateutil
              import cv2
              import numpy
              import plotly
              import regex
              import pdfminer
              import yaml
              import requests
              print('‚úÖ Toutes les d√©pendances sont install√©es avec succ√®s!')
          except ImportError as e:
              print(f'‚ùå Erreur d\\'import: {e}')
              exit(1)
          " || {
              echo "‚ùå Certaines d√©pendances ne sont pas correctement install√©es"
              exit 1
          }
          
              # Marquer l'installation comme compl√®te
              touch "$SETUP_FLAG"
              echo "‚úÖ Installation initiale termin√©e avec succ√®s !"
          fi
          
          # V√©rifier que gui_launcher.py existe
          if [ ! -f "$SCRIPT_DIR/gui_launcher.py" ]; then
              echo "‚ùå Erreur: gui_launcher.py introuvable dans $SCRIPT_DIR"
              echo "üìÇ Contenu du r√©pertoire:"
              ls -la "$SCRIPT_DIR"
              exit 1
          fi
          
          # Lancer l'application
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "  ‚ñ∂Ô∏è  Lancement de l'application..."
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo ""
          echo "üí° L'application va s'ouvrir dans votre navigateur"
          echo "üí° Pour arr√™ter : Fermez ce terminal (Ctrl+C)"
          echo "üí° Environnement: $VENV_DIR"
          echo ""
          
          sleep 2
          
          # Lancer Streamlit depuis l'environnement virtuel
          python -m streamlit run "$SCRIPT_DIR/gui_launcher.py" --server.port 8501 --server.headless true
          # Si Streamlit se ferme (erreur ou arr√™t manuel)
          echo ""
          echo "üîß Pour relancer l'application plus tard :"
          echo "   ./run.sh"
          echo ""
          RUNSCRIPT
          
          chmod +x dist/run.sh
          echo "‚úÖ Script run.sh cr√©√© avec succ√®s"
        shell: bash

        
      - name: üß± Installation des d√©pendances Python avant le build
        shell: bash
        run: |
          python -m pip install --upgrade pip
          if [ -f "app/requirements.txt" ]; then
            python -m pip install -r app/requirements.txt
            echo "‚úÖ D√©pendances install√©es depuis app/requirements.txt"
          else
            python -m pip install streamlit pandas pytesseract Pillow python-dateutil opencv-python-headless numpy plotly regex pdfminer.six PyYAML requests
            echo "‚úÖ D√©pendances par d√©faut install√©es"
          fi

      # ========================================
      # üî® COMPILATION WINDOWS (Version Unique)
      # ========================================
      - name: üî® Compiler l'application (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Write-Host "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          Write-Host "üî® Compilation Gestio V4"
          Write-Host "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          
          # Installation PyInstaller
          python -m pip install --upgrade pip
          python -m pip install pyinstaller
          
          Write-Host ""
          Write-Host "üì¶ Compilation launcher Gestio V4..."
          
          # Nettoyage COMPLET avant compilation
          Write-Host "üßπ Nettoyage des anciens builds..."
          Remove-Item -Recurse -Force dist, build -ErrorAction SilentlyContinue
          Remove-Item -Force *.spec -ErrorAction SilentlyContinue
          Write-Host "‚úÖ Nettoyage termin√©"
          
          Write-Host ""
          Write-Host "üî® Compilation..."
          
          # Compilation launcher simple
          & pyinstaller `
            "app/launch.py" `
            --noconfirm `
            --clean `
            --onefile `
            --windowed `
            --name "GestionFinanciere" `
            --paths "app" `
            --add-data "app/main.py;." `
            --add-data "app/gui_launcher.py;." `
            --add-data "app/config;./config" `
            --add-data "app/domains;./domains" `
            --add-data "app/shared;./shared" `
            --add-data "app/resources;./resources" `
            --add-data ".streamlit;./.streamlit" `
            --hidden-import tkinter `
            --hidden-import requests `
            --hidden-import gui_launcher

          Write-Host ""
          Write-Host "‚úÖ Compilation termin√©e"
          Write-Host ""

          Write-Host "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          Write-Host "üì¶ V√©rification des artefacts compil√©s"
          Write-Host "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"

          New-Item -ItemType Directory -Force -Path dist | Out-Null

          if (Test-Path "tesseract") {
            Copy-Item -Recurse -Force tesseract dist/
            Write-Host "‚úÖ Dossier Tesseract copi√© dans dist/"
          } else {
            Write-Host "‚ö†Ô∏è Aucun dossier Tesseract trouv√©"
          }

          Write-Host ""
          Write-Host "üîç V√©rification du contenu de dist/"
          Get-ChildItem dist/

          Write-Host ""
          Write-Host "‚úÖ Compilation Windows (Portable + Lite) termin√©e avec succ√®s"

      - name: üîç V√©rification post-build de Tesseract embarqu√©
        if: runner.os == 'Windows'
        shell: bash
        run: |
          if [ -d "dist/tesseract" ]; then
            echo "‚úÖ Tesseract bien pr√©sent dans dist/"
            ls -la dist/tesseract
          else
            echo "‚ùå Tesseract manquant dans dist/"
            exit 1
          fi



      - name: üì¶ Cr√©er les packages de distribution (Windows, Linux, macOS)
        shell: bash
        run: |
          echo "üì¶ Pr√©paration des packages de distribution..."
          
          # ==============================
          # ü™ü WINDOWS : Version unique
          # ==============================
          if [[ "$RUNNER_OS" == "Windows" ]]; then
            cd dist
            
            if [ -f "GestionFinanciere.exe" ]; then
              echo "üì¶ Cr√©ation du package Windows..."
              
              # Copier UNIQUEMENT l'installateur PowerShell
              if [ -f "../app/install_and_run_windows.ps1" ]; then
                cp ../app/install_and_run_windows.ps1 .
                echo "‚úÖ Installateur PowerShell copi√©"
              fi
              
              # Copier Tesseract (essentiel pour OCR)
              if [ -d "../tesseract" ]; then
                cp -r ../tesseract ./
                echo "‚úÖ Tesseract embarqu√©"
              fi
              
              # ZIP : UNIQUEMENT exe + install script + tesseract
              # (gui_launcher.py, main.py, config sont dans l'exe via --add-data)
              7z a -tzip GestionFinanciere-Windows.zip \
                GestionFinanciere.exe install_and_run_windows.ps1 tesseract/
              
              echo "‚úÖ Package Windows cr√©√© : GestionFinanciere-Windows.zip"
              echo "   Contenu : exe + install.ps1 + tesseract/"
            else
              echo "‚ùå Erreur : GestionFinanciere.exe introuvable"
            fi
            
            cd ..
          fi
          
          # ==============================
          # üêß LINUX 
          # ==============================
          if [[ "$RUNNER_OS" == "Linux" ]]; then
            echo "üì¶ Cr√©ation du package Linux..."
            mkdir -p dist/linux
            
            # Copier tout app/ SAUF les fichiers Windows-only
            rsync -av --exclude='install_and_run_windows.ps1' --exclude='requirements.txt' app/ dist/linux/
            
            cp -r tesseract dist/linux/ || echo "‚ö†Ô∏è Dossier Tesseract non trouv√© (Linux)"  
            if [ -f "dist/run.sh" ]; then
              cp dist/run.sh dist/linux/
            else
              echo "‚ö†Ô∏è Script run.sh non trouv√© dans dist/, cr√©ation d'un run.sh simplifi√© (fallback)"
              echo "#!/bin/bash" > dist/linux/run.sh
              echo "python3 -m streamlit run gui_launcher.py --server.headless true" >> dist/linux/run.sh
              chmod +x dist/linux/run.sh
            fi
            chmod +x dist/linux/run.sh
            cd dist/linux
            zip -r ../GestionFinanciere-Linux.zip ./
            cd ../..
            echo "‚úÖ Package Linux cr√©√© avec succ√®s (Tesseract inclus)"
          fi
          
          # ==============================
          # üçé MACOS
          # ==============================
          if [[ "$RUNNER_OS" == "macOS" ]]; then
            echo "üì¶ Cr√©ation du package macOS..."
            mkdir -p dist/macos
            
            # Copier tout app/ SAUF les fichiers Windows-only
            rsync -av --exclude='install_and_run_windows.ps1' --exclude='requirements.txt' app/ dist/macos/
            
            cp -r tesseract dist/macos/ || echo "‚ö†Ô∏è Dossier Tesseract non trouv√© (macOS)"
            echo "#!/bin/bash" > dist/macos/run.sh
            echo "python3 -m streamlit run gui_launcher.py --server.headless true" >> dist/macos/run.sh
            chmod +x dist/macos/run.sh
            cd dist/macos
            zip -r ../GestionFinanciere-macOS.zip ./
            cd ../..
            echo "‚úÖ Package macOS cr√©√© avec succ√®s (Tesseract inclus)"  
          fi
          
          
          echo ""
          echo "üìÅ V√©rification du contenu final :"
          ls -la dist/*.zip || echo "‚ö†Ô∏è Aucun ZIP trouv√©"
          echo ""
          echo "‚úÖ Tous les packages de distribution ont √©t√© g√©n√©r√©s avec Tesseract embarqu√©"

      - name: üì§ Upload de l'ex√©cutable pour la Release (DRAFT)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ env.VERSION }}
          name: "Gestion Financi√®re Little ${{ env.VERSION }} ‚Äî ${{ steps.notes.outputs.title }}"
          draft: true
          prerelease: false
          body_path: /tmp/release_notes.md
          files: |
            dist/GestionFinanciere*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
