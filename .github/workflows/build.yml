name: ðŸš€ Build & Release Gestion FinanciÃ¨re Little

permissions:
  contents: write
  actions: read

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    name: Build et Release multi-plateforme
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-latest, ubuntu-latest, macos-latest]

    steps:
      - name: ðŸ§° Checkout du code
        uses: actions/checkout@v4

      - name: ðŸ Installer Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: ðŸ“¦ Copier le dossier Tesseract depuis le dÃ©pÃ´t
        if: runner.os == 'Windows'
        run: |
          if [ -d "tesseract" ]; then
            echo "ðŸ“‚ Dossier tesseract trouvÃ© dans le dÃ©pÃ´t"
            mkdir -p dist/tesseract
            cp -r tesseract/* dist/tesseract/
            echo "âœ… Tesseract local copiÃ© dans dist/"
          else
            echo "âš ï¸ Aucun dossier tesseract trouvÃ© dans le dÃ©pÃ´t"
          fi
        shell: bash

      
      - name: ðŸ“ CrÃ©er le dossier dist
        run: |
          mkdir -p dist
          echo "âœ… Dossier dist crÃ©Ã©"
        shell: bash

      - name: ðŸ“ CrÃ©er script de lancement pour Linux/macOS
        if: runner.os != 'Windows'
        run: |
          cat > dist/run.sh << 'RUNSCRIPT'
          #!/bin/bash
          # Script de lancement Gestion FinanciÃ¨re Little
          
          # Obtenir le rÃ©pertoire du script
          SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
          cd "$SCRIPT_DIR"
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "  ðŸš€ Gestion FinanciÃ¨re Little"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ðŸ“‚ RÃ©pertoire de travail: $SCRIPT_DIR"
          echo ""
          
          # DÃ©tection spÃ©cifique de MX Linux et dÃ©rivÃ©s Debian
          detect_linux_distro() {
              if [ -f /etc/os-release ]; then
                  . /etc/os-release
                  # DÃ©tection spÃ©cifique pour MX Linux
                  if [ -f /etc/mx-version ]; then
                      echo "MX Linux"
                  else
                      echo "$NAME"
                  fi
              elif command -v lsb_release &> /dev/null; then
                  lsb_release -d | cut -f2
              else
                  echo "Unknown"
              fi
          }
          
          DISTRO=$(detect_linux_distro)
          echo "ðŸ§ Distribution dÃ©tectÃ©e: $DISTRO"
          echo ""
          
          # Fonction pour installer Tesseract OCR
          install_tesseract() {
              echo "ðŸ“¦ Installation de Tesseract OCR..."
              case "$DISTRO" in
                  *"Debian"*|*"Ubuntu"*|*"MX"*|*"Linux Mint"*)
                      sudo apt-get update
                      sudo apt-get install -y tesseract-ocr tesseract-ocr-fra || {
                          echo "âŒ Impossible d'installer Tesseract OCR"
                          return 1
                      }
                      ;;
                  *"Fedora"*|*"Red Hat"*|*"CentOS"*)
                      sudo dnf install -y tesseract tesseract-langpack-fra || {
                          echo "âŒ Impossible d'installer Tesseract OCR"
                          return 1
                      }
                      ;;
                  *"Arch"*|*"Manjaro"*)
                      sudo pacman -S --noconfirm tesseract tesseract-data-fra || {
                          echo "âŒ Impossible d'installer Tesseract OCR"
                          return 1
                      }
                      ;;
                  *"macOS"*|*"Darwin"*)
                      if ! command -v brew &> /dev/null; then
                          echo "ðŸ“¦ Installation de Homebrew..."
                          /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
                      fi
                      brew install tesseract tesseract-lang || {
                          echo "âŒ Impossible d'installer Tesseract OCR"
                          return 1
                      }
                      ;;
              esac
              echo "âœ… Tesseract OCR installÃ© avec succÃ¨s !"
              return 0
          }

          # Fonction pour installer les dÃ©pendances OpenCV
          install_opencv_deps() {
              echo "ðŸ“¦ Installation des dÃ©pendances OpenCV..."
              case "$DISTRO" in
                  *"Debian"*|*"Ubuntu"*|*"MX"*|*"Linux Mint"*)
                      sudo apt-get install -y libglib2.0-0 libsm6 libxrender1 libxext6 libgl1-mesa-glx || {
                          echo "âŒ Impossible d'installer les dÃ©pendances OpenCV"
                          return 1
                      }
                      ;;
                  *"Fedora"*|*"Red Hat"*|*"CentOS"*)
                      sudo dnf install -y glib2 libSM libXrender libXext mesa-libGL || {
                          echo "âŒ Impossible d'installer les dÃ©pendances OpenCV"
                          return 1
                      }
                      ;;
                  *"Arch"*|*"Manjaro"*)
                      sudo pacman -S --noconfirm glib2 libsm libxrender libxext mesa || {
                          echo "âŒ Impossible d'installer les dÃ©pendances OpenCV"
                          return 1
                      }
                      ;;
              esac
              echo "âœ… DÃ©pendances OpenCV installÃ©es avec succÃ¨s !"
              return 0
          }
          
          # VÃ©rifier la version de Python
          check_python_version() {
              python3 -c "import sys; exit(0) if sys.version_info >= (3, 8) else exit(1)" || {
                  echo "âŒ Python 3.8+ requis. Version actuelle: $(python3 --version)"
                  return 1
              }
              return 0
          }
          
          # VÃ©rifier Python
          if ! command -v python3 &> /dev/null; then
              echo "âš ï¸  Python 3 n'est pas installÃ© sur votre systÃ¨me."
              echo ""
              read -p "â“ Voulez-vous que je l'installe automatiquement ? (o/N) " response
              
              if [[ "$response" =~ ^[OoYy]$ ]]; then
                  case "$DISTRO" in
                      *"Debian"*|*"Ubuntu"*|*"MX"*|*"Linux Mint"*)
                          sudo apt-get update || {
                              echo "âŒ Ã‰chec de la mise Ã  jour des paquets"
                              exit 1
                          }
                          sudo apt-get install -y python3 python3-pip python3-venv python3-full || {
                              echo "âŒ Ã‰chec de l'installation automatique."
                              echo "ðŸ“‹ Essayez manuellement : sudo apt install python3 python3-pip python3-venv"
                              exit 1
                          }
                          ;;
                      *"Fedora"*|*"Red Hat"*|*"CentOS"*)
                          sudo dnf install -y python3 python3-pip python3-virtualenv || {
                              echo "âŒ Ã‰chec de l'installation automatique."
                              echo "ðŸ“‹ Essayez manuellement : sudo dnf install python3 python3-pip"
                              exit 1
                          }
                          ;;
                      *"Arch"*|*"Manjaro"*)
                          sudo pacman -S --noconfirm python python-pip python-virtualenv || {
                              echo "âŒ Ã‰chec de l'installation automatique."
                              echo "ðŸ“‹ Essayez manuellement : sudo pacman -S python python-pip"
                              exit 1
                          }
                          ;;
                      *"macOS"*|*"Darwin"*)
                          if ! command -v brew &> /dev/null; then
                              echo "ðŸ“¦ Installation de Homebrew..."
                              /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
                          fi
                          brew install python@3.11 || {
                              echo "âŒ Ã‰chec de l'installation automatique."
                              echo "ðŸ“‹ Essayez manuellement : brew install python@3.11"
                              exit 1
                          }
                          ;;
                      *)
                          echo "âŒ Distribution non supportÃ©e pour l'installation automatique."
                          echo "ðŸ“‹ Installez Python manuellement pour votre distribution."
                          exit 1
                          ;;
                  esac
                  echo "âœ… Python installÃ© avec succÃ¨s !"
              else
                  echo ""
                  echo "ðŸ“‹ Installez Python manuellement, puis relancez ce script."
                  exit 1
              fi
          fi
          
          # VÃ©rifier la version de Python
          check_python_version || exit 1
          echo "âœ… Python dÃ©tectÃ©: $(python3 --version)"
          echo ""
          
          # VÃ©rifier et installer Tesseract OCR
          if ! command -v tesseract &> /dev/null; then
              echo "ðŸ” Tesseract OCR non dÃ©tectÃ©."
              echo ""
              read -p "â“ Voulez-vous installer Tesseract OCR (nÃ©cessaire pour l'OCR) ? (O/n) " tesseract_response
              
              if [[ "$tesseract_response" =~ ^[OoYy]*$ ]] || [ -z "$tesseract_response" ]; then
                  install_tesseract || {
                      echo "âš ï¸  Tesseract OCR n'est pas installÃ©. L'OCR ne fonctionnera pas."
                  }
              else
                  echo "âš ï¸  Tesseract OCR non installÃ©. L'OCR ne fonctionnera pas."
              fi
          else
              echo "âœ… Tesseract OCR dÃ©tectÃ©: $(tesseract --version | head -n1)"
          fi

          # Installer les dÃ©pendances OpenCV
          echo ""
          echo "ðŸ” Installation des dÃ©pendances OpenCV..."
          install_opencv_deps || {
              echo "âš ï¸  Les dÃ©pendances OpenCV ne sont pas installÃ©es. Certaines fonctionnalitÃ©s peuvent ne pas fonctionner."
          }
          echo ""
          
          # Utilisation d'un environnement virtuel
          VENV_DIR="$SCRIPT_DIR/.little_finance_env"
          echo "ðŸ”§ Configuration de l'environnement Python..."
          
          # VÃ©rifier si l'environnement existe dÃ©jÃ 
          if [ ! -d "$VENV_DIR" ]; then
              echo "ðŸ“¦ CrÃ©ation de l'environnement virtuel Python..."
              
              # VÃ©rifier si python3-venv est installÃ©
              if ! python3 -c "import venv" 2>/dev/null; then
                  echo "âš ï¸  Le module venv n'est pas disponible."
                  echo "ðŸ“¦ Installation de python3-venv..."
                  
                  case "$DISTRO" in
                      *"Debian"*|*"Ubuntu"*|*"MX"*|*"Linux Mint"*)
                          sudo apt-get install -y python3-venv python3-full || {
                              echo "âŒ Impossible d'installer python3-venv"
                              echo "ðŸ’¡ Essayez: sudo apt install python3-venv python3-full"
                              exit 1
                          }
                          ;;
                      *"Fedora"*|*"Red Hat"*|*"CentOS"*)
                          sudo dnf install -y python3-virtualenv || {
                              echo "âŒ Impossible d'installer python3-virtualenv"
                              exit 1
                          }
                          ;;
                      *"Arch"*|*"Manjaro"*)
                          sudo pacman -S --noconfirm python-virtualenv || {
                              echo "âŒ Impossible d'installer python-virtualenv"
                              exit 1
                          }
                          ;;
                      *"macOS"*|*"Darwin"*)
                          echo "âœ… venv devrait Ãªtre disponible avec Python"
                          ;;
                  esac
              fi
              
              python3 -m venv "$VENV_DIR" || {
                  echo "âŒ Impossible de crÃ©er l'environnement virtuel"
                  exit 1
              }
              echo "âœ… Environnement virtuel crÃ©Ã© !"
          else
              echo "âœ… Environnement virtuel existant dÃ©tectÃ©"
          fi
          
          # Activer l'environnement virtuel
          source "$VENV_DIR/bin/activate"
          echo "âœ… Environnement virtuel activÃ©"
          
          # Installation de TOUTES les dÃ©pendances Python
          echo "ðŸ“¦ Installation des dÃ©pendances Python..."
          python -m pip install --upgrade pip --quiet
          python -m pip install streamlit pandas pytesseract Pillow python-dateutil opencv-python-headless numpy matplotlib pdfminer.six requests --quiet || {
              echo "âŒ Erreur lors de l'installation des dÃ©pendances"
              echo "ðŸ” Nouvelle tentative avec des options Ã©tendues..."
              python -m pip install streamlit pandas pytesseract Pillow python-dateutil opencv-python-headless numpy matplotlib pdfminer.six requests --no-cache-dir || {
                  echo "âŒ Ã‰chec critique de l'installation des dÃ©pendances"
                  exit 1
              }
          }
          echo "âœ… DÃ©pendances installÃ©es dans l'environnement virtuel !"
          
          # VÃ©rification CRITIQUE que pytesseract est bien installÃ©
          echo "ðŸ” VÃ©rification de l'installation de pytesseract..."
          python -c "import pytesseract; print('âœ… pytesseract importÃ© avec succÃ¨s')" || {
              echo "âŒ pytesseract non installÃ©, tentative de rÃ©installation..."
              python -m pip install pytesseract --force-reinstall --no-cache-dir || {
                  echo "âŒ Ã‰chec critique de l'installation de pytesseract"
                  echo "ðŸ’¡ Le module OCR ne fonctionnera pas"
              }
          }

          # VÃ©rification de OpenCV
          echo "ðŸ” VÃ©rification de l'installation de OpenCV..."
          python -c "import cv2; print('âœ… OpenCV importÃ© avec succÃ¨s')" || {
              echo "âŒ OpenCV non installÃ©, tentative de rÃ©installation..."
              python -m pip install opencv-python-headless --force-reinstall --no-cache-dir || {
                  echo "âŒ Ã‰chec critique de l'installation de OpenCV"
                  echo "ðŸ’¡ Le traitement d'image ne fonctionnera pas"
              }
          }
          
          # VÃ©rification finale de toutes les dÃ©pendances
          echo "ðŸ” VÃ©rification finale des dÃ©pendances..."
          python -c "
          try:
              import streamlit
              import pandas
              import pytesseract
              import PIL
              import dateutil
              import cv2
              import numpy
              import matplotlib
              import requests
              print('âœ… Toutes les dÃ©pendances sont installÃ©es avec succÃ¨s!')
          except ImportError as e:
              print(f'âŒ Erreur d\\'import: {e}')
              exit(1)
          " || {
              echo "âŒ Certaines dÃ©pendances ne sont pas correctement installÃ©es"
              exit 1
          }
          
          # VÃ©rifier que gestiolittle.py existe
          if [ ! -f "$SCRIPT_DIR/gestiolittle.py" ]; then
              echo "âŒ Erreur: gestiolittle.py introuvable dans $SCRIPT_DIR"
              echo "ðŸ“‚ Contenu du rÃ©pertoire:"
              ls -la "$SCRIPT_DIR"
              exit 1
          fi
          
          # Lancer l'application
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "  â–¶ï¸  Lancement de l'application..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ðŸ’¡ L'application va s'ouvrir dans votre navigateur"
          echo "ðŸ’¡ Pour arrÃªter : Fermez ce terminal (Ctrl+C)"
          echo "ðŸ’¡ Environnement: $VENV_DIR"
          echo ""
          
          sleep 2
          
          # Lancer Streamlit depuis l'environnement virtuel
          python -m streamlit run "$SCRIPT_DIR/gestiolittle.py" --server.port 8501 --server.headless true

          # Si Streamlit se ferme (erreur ou arrÃªt manuel)
          echo ""
          echo "ðŸ”§ Pour relancer l'application plus tard :"
          echo "   ./run.sh"
          echo ""
          RUNSCRIPT
          
          chmod +x dist/run.sh
          echo "âœ… Script run.sh crÃ©Ã© avec succÃ¨s"
        shell: bash

      - name: ðŸ§± Installation des dÃ©pendances Python avant le build
        shell: bash
        run: |
          python -m pip install --upgrade pip
          python -m pip install streamlit pandas pytesseract Pillow python-dateutil opencv-python-headless numpy matplotlib pdfminer.six requests
          echo "âœ… Toutes les dÃ©pendances nÃ©cessaires au build sont installÃ©es"

      - name: ðŸ—ï¸ Compiler les deux versions Windows (Portable + Lite)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Write-Host "ðŸ—ï¸ Compilation Gestion FinanciÃ¨re Little (Windows uniquement)..."

          # ðŸ”§ Installation / mise Ã  jour des outils nÃ©cessaires
          python -m pip install --upgrade pip
          python -m pip install pyinstaller pyinstaller-hooks-contrib

          Write-Host ""
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          Write-Host "ðŸ”¹ VERSION PORTABLE (autonome, sans installateur ni questions)"
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          & pyinstaller `
            "app/lancer_gestiolittle.py" `
            --noconfirm `
            --clean `
            --onefile `
            --console `
            --name "GestionFinanciereLittle_Portable" `
            --add-data "app;app" `
            --add-data "tesseract;tesseract" `
            --collect-all streamlit `
            --collect-all pandas `
            --collect-all PIL `
            --collect-all pytesseract `
            --collect-all cv2 `
            --collect-all numpy `
            --collect-all matplotlib `
            --collect-all pdfminer `
            --hidden-import streamlit `
            --hidden-import streamlit.web.bootstrap `
            --hidden-import streamlit.web.server.browser_websocket_handler `
            --hidden-import streamlit.runtime.scriptrunner.script_runner `
            --hidden-import pandas `
            --hidden-import numpy `
            --hidden-import matplotlib `
            --hidden-import pytesseract `
            --hidden-import Pillow `
            --hidden-import cv2 `
            --hidden-import pdfminer `
            --hidden-import pdfminer.six `
            --hidden-import requests `
            --hidden-import python-dateutil 

          Write-Host ""
          Write-Host "âœ… Compilation de la version Portable terminÃ©e"
          Write-Host ""

          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          Write-Host "ðŸ“¦ VÃ©rification post-compilation (Portable)"
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          Get-ChildItem dist/
          Write-Host ""

          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          Write-Host "ðŸ”¹ VERSION LITE (utilisant le Python global)"
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          & pyinstaller `
            "app/lancer_gestiolite.py" `
            --noconfirm `
            --clean `
            --onefile `
            --console `
            --name "GestionFinanciereLittle_Lite" `
            --exclude-module pytest `
            --exclude-module setuptools `
            --exclude-module pip `
            --exclude-module wheel `
            --exclude-module test `
            --exclude-module unittest `
            --exclude-module streamlit `
            --exclude-module pandas `
            --exclude-module numpy `
            --exclude-module matplotlib `
            --exclude-module pytesseract `
            --exclude-module Pillow `
            --exclude-module opencv-python-headless `
            --exclude-module cv2 `
            --exclude-module pdfminer `
            --exclude-module pdfminer.six `
            --exclude-module requests `
            --exclude-module python-dateutil 

          Write-Host ""
          Write-Host "âœ… Compilation de la version Lite terminÃ©e"
          Write-Host ""

          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          Write-Host "ðŸ“¦ Copie des fichiers additionnels"
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          New-Item -ItemType Directory -Force -Path dist | Out-Null
          Copy-Item app/configlittle.py dist/ -ErrorAction SilentlyContinue
          Copy-Item app/auto_updater.py dist/ -ErrorAction SilentlyContinue
          Copy-Item app/changelog_viewer.py dist/ -ErrorAction SilentlyContinue
          Copy-Item app/gestiolittle.py dist/ -ErrorAction SilentlyContinue

          if (Test-Path "tesseract") {
            Copy-Item -Recurse -Force tesseract dist/
            Write-Host "âœ… Dossier Tesseract copiÃ© dans dist/"
          } else {
            Write-Host "âš ï¸ Aucun dossier Tesseract trouvÃ©"
          }

          Write-Host ""
          Write-Host "ðŸ” VÃ©rification du contenu de dist/"
          Get-ChildItem dist/

          Write-Host ""
          Write-Host "âœ… Compilation Windows (Portable + Lite) terminÃ©e avec succÃ¨s"

      - name: ðŸ” VÃ©rification post-build de Tesseract embarquÃ©
        if: runner.os == 'Windows'
        shell: bash
        run: |
          if [ -d "dist/tesseract" ]; then
            echo "âœ… Tesseract bien prÃ©sent dans dist/"
            ls -la dist/tesseract
          else
            echo "âŒ Tesseract manquant dans dist/"
            exit 1
          fi



      - name: ðŸ“¦ CrÃ©er les packages de distribution (Windows, Linux, macOS)
        shell: bash
        run: |
          echo "ðŸ“¦ PrÃ©paration des packages de distribution..."

          # ==============================
          # ðŸªŸ WINDOWS : Portable + Lite
          # ==============================
          if [[ "$RUNNER_OS" == "Windows" ]]; then
            cd dist

            # ---------- VERSION PORTABLE ----------
            if [ -f "GestionFinanciereLittle_Portable.exe" ]; then
              echo "ðŸ“¦ CrÃ©ation du package Windows Portable..."

              # Copier Tesseract embarquÃ© depuis le dÃ©pÃ´t
              if [ -d "../tesseract" ]; then
                echo "ðŸ“‚ Copie du dossier Tesseract depuis le dÃ©pÃ´t..."
                cp -r ../tesseract ./
              fi

              7z a -tzip GestionFinanciereLittle-Windows-Portable.zip \
                GestionFinanciereLittle_Portable.exe *.py tesseract/

              echo "âœ… Package Portable crÃ©Ã© avec Tesseract embarquÃ©"
            else
              echo "âŒ Erreur : GestionFinanciereLittle_Portable.exe introuvable"
            fi

            # ---------- VERSION LITE ----------
            if [ -f "GestionFinanciereLittle_Lite.exe" ]; then
              echo "ðŸ“¦ CrÃ©ation du package Windows Lite..."

              # Copier installateur et launcher
              if [ -f "../app/install_and_run_windows.ps1" ] then
                cp ../app/install_and_run_windows.ps1 .
                echo "âœ… Installateur Python "
              else
                echo "âš ï¸ Fichiers dâ€™installation manquants"
              fi

              # Copier Tesseract embarquÃ© (sÃ©curitÃ© OCR)
              if [ -d "../tesseract" ]; then
                cp -r ../tesseract ./
                echo "âœ… Dossier Tesseract embarquÃ© ajoutÃ© dans la version Lite"
              fi

              7z a -tzip GestionFinanciereLittle-Windows-Lite.zip \
                GestionFinanciereLittle_Lite.exe *.py *.bat *.ps1 tesseract/

              echo "âœ… Package Lite crÃ©Ã© (Tesseract embarquÃ© + installateur)"
            else
              echo "âŒ Erreur : GestionFinanciereLittle_Lite.exe introuvable"
            fi

            cd ..
          fi


          # ==============================
          # ðŸ§ LINUX
          # ==============================
          if [[ "$RUNNER_OS" == "Linux" ]]; then
            echo "ðŸ“¦ CrÃ©ation du package Linux..."
            mkdir -p dist/linux
            cp app/*.py dist/linux/
            cp -r tesseract dist/linux/ || echo "âš ï¸ Dossier Tesseract non trouvÃ© (Linux)"
            echo "#!/bin/bash" > dist/linux/run.sh
            echo "python3 -m streamlit run gestiolittle.py --server.headless true" >> dist/linux/run.sh
            chmod +x dist/linux/run.sh
            cd dist/linux
            zip -r ../GestionFinanciereLittle-Linux.zip ./
            cd ../..
            echo "âœ… Package Linux crÃ©Ã© avec succÃ¨s (Tesseract inclus)"
          fi


          # ==============================
          # ðŸŽ MACOS
          # ==============================
          if [[ "$RUNNER_OS" == "macOS" ]]; then
            echo "ðŸ“¦ CrÃ©ation du package macOS..."
            mkdir -p dist/macos
            cp app/*.py dist/macos/
            cp -r tesseract dist/macos/ || echo "âš ï¸ Dossier Tesseract non trouvÃ© (macOS)"
            echo "#!/bin/bash" > dist/macos/run.sh
            echo "python3 -m streamlit run gestiolittle.py --server.headless true" >> dist/macos/run.sh
            chmod +x dist/macos/run.sh
            cd dist/macos
            zip -r ../GestionFinanciereLittle-macOS.zip ./
            cd ../..
            echo "âœ… Package macOS crÃ©Ã© avec succÃ¨s (Tesseract inclus)"
          fi


          echo ""
          echo "ðŸ“ VÃ©rification du contenu final :"
          ls -la dist/*.zip || echo "âš ï¸ Aucun ZIP trouvÃ©"
          echo ""
          echo "âœ… Tous les packages de distribution ont Ã©tÃ© gÃ©nÃ©rÃ©s avec Tesseract embarquÃ©"

      - name: ðŸ”¢ Lire la version depuis VERSION.txt
        id: ver
        run: |
          if [ ! -f version.txt ]; then
            echo "VERSION=0.0.0" >> $GITHUB_ENV
          else
            V=$(cat version.txt | tr -d ' \r\n')
            echo "VERSION=$V" >> $GITHUB_ENV
          fi
        shell: bash

      - name: ðŸ“ GÃ©nÃ©rer titre + notes (conventional commits)
        id: notes
        run: |
          set -e

          if git describe --tags --abbrev=0 >/tmp/last_tag 2>/dev/null; then
            LAST_TAG=$(cat /tmp/last_tag)
          else
            LAST_TAG=""
          fi
          if [ -n "$LAST_TAG" ]; then
            RANGE="${LAST_TAG}..HEAD"
          else
            RANGE="HEAD"
          fi

          # RÃ©cupÃ©rer les messages de commit
          git log --pretty=format:%s $RANGE > /tmp/commits.txt || true

          # Flags par type
          HAS_BREAK=$(grep -Ei '(^.*!|BREAKING CHANGE:)' /tmp/commits.txt || true)
          HAS_FEAT=$(grep -Ei '^feat(\(|:)' /tmp/commits.txt || true)
          HAS_FIX=$(grep -Ei '^fix(\(|:)' /tmp/commits.txt || true)
          HAS_PERF=$(grep -Ei '^perf(\(|:)' /tmp/commits.txt || true)
          HAS_REFACTOR=$(grep -Ei '^refactor(\(|:)' /tmp/commits.txt || true)
          HAS_DOCS=$(grep -Ei '^docs(\(|:)' /tmp/commits.txt || true)
          HAS_CHORE=$(grep -Ei '^chore(\(|:)' /tmp/commits.txt || true)

          # Titre dynamique
          TITLE="ðŸ”§ Maintenance"
          if [ -n "$HAS_BREAK" ]; then
            TITLE="ðŸ’¥ Changements majeurs"
          elif [ -n "$HAS_FEAT" ] && [ -n "$HAS_FIX" ]; then
            TITLE="âœ¨ Nouvelles fonctionnalitÃ©s & ðŸ› Corrections"
          elif [ -n "$HAS_FEAT" ]; then
            TITLE="âœ¨ Nouvelles fonctionnalitÃ©s"
          elif [ -n "$HAS_FIX" ]; then
            TITLE="ðŸ› Corrections de bugs"
          elif [ -n "$HAS_PERF" ]; then
            TITLE="âš¡ AmÃ©liorations de performances"
          elif [ -n "$HAS_REFACTOR" ]; then
            TITLE="ðŸ§¹ Refactor"
          elif [ -n "$HAS_DOCS" ]; then
            TITLE="ðŸ“ Documentation"
          fi

          # Corps : regrouper par section
          body() {
            SEC="$1"; PAT="$2"
            MATCHES=$(grep -E "$PAT" /tmp/commits.txt | sed -E 's/^[a-z]+(\([^)]+\))?:\s*//' || true)
            if [ -n "$MATCHES" ]; then
              echo "### $SEC"
              echo "$MATCHES" | sed 's/^/- /'
              echo
            fi
          }

          {
            echo "## ${TITLE} â€” ${{ env.VERSION }}"
            echo
            [ -n "$HAS_BREAK" ] && echo "### ðŸ’¥ Breaking changes" && \
              grep -Ei '(^.*!|BREAKING CHANGE:)' /tmp/commits.txt | sed 's/^/- /' && echo
            body "âœ¨ Features" '^feat(\(|:)'
            body "ðŸ› Fixes" '^fix(\(|:)'
            body "âš¡ Perf" '^perf(\(|:)'
            body "ðŸ§¹ Refactor" '^refactor(\(|:)'
            body "ðŸ“ Docs" '^docs(\(|:)'
            body "ðŸ”§ Chore" '^chore(\(|:)'
          } > /tmp/release_notes.md

          echo "title=${TITLE}" >> $GITHUB_OUTPUT
        shell: bash

      - name: ðŸ“¤ Upload de l'exÃ©cutable pour la Release (DRAFT)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ env.VERSION }}
          name: "Gestion FinanciÃ¨re Little ${{ env.VERSION }} â€” ${{ steps.notes.outputs.title }}"
          draft: true
          prerelease: false
          body_path: /tmp/release_notes.md
          files: |
            dist/GestionFinanciereLittle*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}