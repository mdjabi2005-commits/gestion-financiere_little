name: üöÄ Mettre √† jour automatiquement les releases

on:
  release:
    types: [published, edited]

permissions:
  contents: write
  packages: write

jobs:
  enhance-release:
    runs-on: ubuntu-latest
    if: github.event.release.draft == false
    
    steps:
      - name: üîç V√©rifier le contexte
        run: |
          echo "√âv√©nement: ${{ github.event_name }}"
          echo "Tag: ${{ github.event.release.tag_name }}"
          echo "Draft: ${{ github.event.release.draft }}"

      - name: üß© R√©cup√©rer le d√©p√¥t
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: üß† Installer GitHub CLI
        run: |
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt update
          sudo apt install gh -y

      - name: üîë Configurer l'authentification GitHub
        run: |
          gh auth login --with-token <<< "${{ secrets.GITHUB_TOKEN }}"

      - name: üìä Analyser le contenu de la release
        id: analyze
        run: |
          TAG_NAME="${{ github.event.release.tag_name }}"
          BODY="${{ github.event.release.body }}"
          
          echo "üìñ Contenu analys√© :"
          echo "$BODY"
          
          # D√©tection du type bas√©e sur des patterns plus pr√©cis
          if echo "$BODY" | grep -qiE "(feat|feature|nouvelle|ajout|fonctionnalit√©)"; then
            TYPE="feat"
            EMOJI="‚ú®"
            DESC="Nouvelles fonctionnalit√©s"
          elif echo "$BODY" | grep -qiE "(fix|bug|correction|erreur|probl√®me)"; then
            TYPE="fix" 
            EMOJI="üêõ"
            DESC="Corrections de bugs"
          elif echo "$BODY" | grep -qiE "(perf|performance|optimisation|am√©lioration|rapidit√©)"; then
            TYPE="perf"
            EMOJI="‚ö°"
            DESC="Optimisations performances"
          elif echo "$BODY" | grep -qiE "(refactor|refacto|nettoyage|restructuration)"; then
            TYPE="refactor"
            EMOJI="‚ôªÔ∏è"
            DESC="Restructuration du code"
          elif echo "$BODY" | grep -qiE "(doc|documentation|readme|aide)"; then
            TYPE="docs"
            EMOJI="üìö"
            DESC="Documentation"
          else
            TYPE="chore"
            EMOJI="üîß"
            DESC="Maintenance et am√©liorations"
          fi
          
          echo "TYPE=$TYPE" >> $GITHUB_OUTPUT
          echo "EMOJI=$EMOJI" >> $GITHUB_OUTPUT
          echo "DESC=$DESC" >> $GITHUB_OUTPUT
          echo "TAG_NAME=$TAG_NAME" >> $GITHUB_OUTPUT

      - name: üè∑Ô∏è G√©n√©rer le titre am√©lior√©
        id: title
        run: |
          TITLE="${{ steps.analyze.outputs.EMOJI }} Gestion Financi√®re Little ${{ steps.analyze.outputs.TAG_NAME }} ‚Äì ${{ steps.analyze.outputs.DESC }}"
          echo "Nouveau titre : $TITLE"
          echo "TITLE=$TITLE" >> $GITHUB_OUTPUT

      - name: üìù G√©n√©rer le body am√©lior√©
        id: body
        run: |
          ORIGINAL_BODY="${{ github.event.release.body }}"
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          
          ENHANCED_BODY=$(cat << EOF
          ## üéØ ${{ steps.analyze.outputs.DESC }}
          
          **üìÖ Date de publication :** \`$TIMESTAMP\`
          **üè∑Ô∏è Version :** \`${{ steps.analyze.outputs.TAG_NAME }}\`
          **üì¶ Type :** ${{ steps.analyze.outputs.EMOJI }} ${{ steps.analyze.outputs.DESC }}
          
          ---
          
          $ORIGINAL_BODY
          
          ---
          
          ### üì• Installation
          \`\`\`bash
          # T√©l√©chargez la derni√®re version depuis GitHub Releases
          # Ex√©cutez le fichier correspondant √† votre OS
          \`\`\`
          
          ### üêõ Signaler un probl√®me
          Si vous rencontrez un bug, [ouvrez une issue](${{ github.server_url }}/${{ github.repository }}/issues/new).
          
          *‚ú® G√©n√©r√© automatiquement par GitHub Actions*
          EOF
          )
          
          echo "ENHANCED_BODY<<EOF" >> $GITHUB_OUTPUT
          echo "$ENHANCED_BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: üöÄ Mettre √† jour la release
        run: |
          echo "üîÑ Mise √† jour de la release ${{ steps.analyze.outputs.TAG_NAME }}..."
          gh release edit "${{ steps.analyze.outputs.TAG_NAME }}" \
            --title "${{ steps.title.outputs.TITLE }}" \
            --notes "${{ steps.body.outputs.ENHANCED_BODY }}"
          
          echo "‚úÖ Release mise √† jour avec succ√®s !"

      - name: üìä Cr√©er un r√©sum√© du workflow
        run: |
          echo "## üéâ Release Optimis√©e" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ **Release mise √† jour avec succ√®s**" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag :** ${{ steps.analyze.outputs.TAG_NAME }}" >> $GITHUB_STEP_SUMMARY  
          echo "- **Type :** ${{ steps.analyze.outputs.EMOJI }} ${{ steps.analyze.outputs.DESC }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Titre :** ${{ steps.title.outputs.TITLE }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üìä La release a √©t√© automatiquement enrichie avec :" >> $GITHUB_STEP_SUMMARY
          echo "- üè∑Ô∏è Titre descriptif" >> $GITHUB_STEP_SUMMARY
          echo "- üìù En-t√™te informatif" >> $GITHUB_STEP_SUMMARY
          echo "- üì• Instructions d'installation" >> $GITHUB_STEP_SUMMARY
          echo "- üîó Lien pour reporter les bugs" >> $GITHUB_STEP_SUMMARY